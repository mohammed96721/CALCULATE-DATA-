<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة تكاليف البناء</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            direction: rtl;
        }
        h1 {
            text-align: center;
            color: #0a3d62;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .form-section {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .form-section h2 {
            margin: 0 0 10px;
            color: #0a3d62;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-section .toggle-icon {
            transition: transform 0.3s;
        }
        .form-section .toggle-icon.open {
            transform: rotate(180deg);
        }
        .form-section .content {
            display: none;
        }
        .form-section .content.active {
            display: block;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #0a3d62;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0d5180;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #resultContainer {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        #resultContent {
            line-height: 1.6;
        }
        #downloadPdf {
            margin-top: 10px;
            background-color: #28a745;
        }
        #downloadPdf:hover {
            background-color: #218838;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>حاسبة تكاليف البناء</h1>
    <div class="form-container">
        <form id="buildingForm">
            <!-- معلومات العميل -->
            <div class="form-section">
                <h2>معلومات العميل <span class="toggle-icon">▼</span></h2>
                <div class="content active">
                    <label for="customerName">اسم العميل:</label>
                    <input type="text" id="customerName" name="customerName">

                    <label for="phoneNumber">رقم الهاتف:</label>
                    <input type="text" id="phoneNumber" name="phoneNumber">
                </div>
            </div>

            <!-- معلومات الموقع -->
            <div class="form-section">
                <h2>معلومات الموقع <span class="toggle-icon">▼</span></h2>
                <div class="content active">
                    <label for="governorate">المحافظة:</label>
                    <input type="text" id="governorate" name="governorate">

                    <label for="area">المنطقة:</label>
                    <input type="text" id="area" name="area">
                </div>
            </div>

            <!-- تفاصيل الأرض -->
            <div class="form-section">
                <h2>تفاصيل الأرض <span class="toggle-icon">▼</span></h2>
                <div class="content active">
                    <label for="landArea">مساحة الأرض (متر مربع):</label>
                    <input type="number" id="landArea" name="landArea" step="any">

                    <label for="facadeWidth">عرض الواجهة (متر):</label>
                    <input type="number" id="facadeWidth" name="facadeWidth" step="any">
                </div>
            </div>

            <!-- تفاصيل المبنى -->
            <div class="form-section">
                <h2>تفاصيل المبنى <span class="toggle-icon">▼</span></h2>
                <div class="content active">
                    <label for="floors">عدد الطوابق:</label>
                    <input type="number" id="floors" name="floors">

                    <label for="rooms">عدد الغرف:</label>
                    <input type="number" id="rooms" name="rooms">

                    <label for="bathrooms">عدد الحمامات:</label>
                    <input type="number" id="bathrooms" name="bathrooms">

                    <label for="groundFloorHeight">ارتفاع الطابق الأرضي (متر):</label>
                    <input type="number" id="groundFloorHeight" name="groundFloorHeight" step="any">

                    <label for="otherFloorsHeight">ارتفاع الطوابق الأخرى (متر):</label>
                    <input type="number" id="otherFloorsHeight" name="otherFloorsHeight" step="any">

                    <label for="brickType">نوع الطابوق:</label>
                    <select id="brickType" name="brickType">
                        <option value="">اختر</option>
                        <option value="standard">قياسي</option>
                        <option value="other">آخر</option>
                    </select>

                    <div id="otherBrickInfo" class="hidden">
                        <label for="brickWidth">عرض الطابوق (سم):</label>
                        <input type="number" id="brickWidth" name="brickWidth" step="any">

                        <label for="brickLength">طول الطابوق (سم):</label>
                        <input type="number" id="brickLength" name="brickLength" step="any">

                        <label for="brickHeight">ارتفاع الطابوق (سم):</label>
                        <input type="number" id="brickHeight" name="brickHeight" step="any">

                        <label for="brickDensity">كثافة الطابوق:</label>
                        <input type="number" id="brickDensity" name="brickDensity" step="any">
                    </div>

                    <label for="woodType">نوع الخشب:</label>
                    <select id="woodType" name="woodType">
                        <option value="">اختر</option>
                        <option value="oak">بلوط</option>
                        <option value="pine">صنوبر</option>
                    </select>

                    <label for="facadeType">نوع الواجهة:</label>
                    <select id="facadeType" name="facadeType">
                        <option value="">اختر</option>
                        <option value="standard">قياسي</option>
                        <option value="custom">مخصص</option>
                    </select>

                    <div id="customFacadeInfo" class="hidden">
                        <label for="facadeArea">مساحة الواجهة (متر مربع):</label>
                        <input type="number" id="facadeArea" name="facadeArea" step="any">

                        <label for="facadePrice">سعر الواجهة (دينار/متر مربع):</label>
                        <input type="number" id="facadePrice" name="facadePrice" step="any">
                    </div>

                    <label><input type="checkbox" id="hasGarden" name="hasGarden"> وجود حديقة</label>
                    <label><input type="checkbox" id="hasPool" name="hasPool"> وجود مسبح</label>
                    <label><input type="checkbox" id="hasHVAC" name="hasHVAC"> وجود تكييف مركزي</label>
                    <label><input type="checkbox" id="hasElevator" name="hasElevator"> وجود مصعد</label>
                    <label><input type="checkbox" id="hasFence" name="hasFence"> وجود سياج</label>

                    <label for="concreteVolume">حجم الخرسانة للأعمدة (متر مكعب):</label>
                    <input type="number" id="concreteVolume" name="concreteVolume" step="any">

                    <label for="apartmentsCount">عدد الشقق:</label>
                    <input type="number" id="apartmentsCount" name="apartmentsCount">

                    <label for="internalWallsArea">مساحة الجدران الداخلية (متر مربع):</label>
                    <input type="number" id="internalWallsArea" name="internalWallsArea" step="any">

                    <label for="internalWallsPrice">سعر الجدران الداخلية (دينار/متر مربع):</label>
                    <input type="number" id="internalWallsPrice" name="internalWallsPrice" step="any">

                    <label for="basementFloors">عدد طوابق القبو:</label>
                    <input type="number" id="basementFloors" name="basementFloors">

                    <label for="basementCeilingArea">مساحة سقف القبو (متر مربع):</label>
                    <input type="number" id="basementCeilingArea" name="basementCeilingArea" step="any">

                    <label for="basementPrice">سعر القبو (دينار/متر مربع):</label>
                    <input type="number" id="basementPrice" name="basementPrice" step="any">
                </div>
            </div>

            <!-- الأسعار -->
            <div class="form-section">
                <h2>الأسعار <span class="toggle-icon">▼</span></h2>
                <div class="content active">
                    <label for="flooringPrice">سعر الأرضيات (دينار/متر مربع):</label>
                    <input type="number" id="flooringPrice" name="flooringPrice" step="any">

                    <label for="wallInstallationPrice">سعر تركيب الجدران (دينار/متر مربع):</label>
                    <input type="number" id="wallInstallationPrice" name="wallInstallationPrice" step="any">

                    <label for="wallPaintingPrice">سعر صبغ الجدران (دينار/متر مربع):</label>
                    <input type="number" id="wallPaintingPrice" name="wallPaintingPrice" step="any">

                    <label for="windowsDoorsPrice">سعر الشبابيك والأبواب (دينار/متر مربع):</label>
                    <input type="number" id="windowsDoorsPrice" name="windowsDoorsPrice" step="any">

                    <label for="stairsRailingPrice">سعر محجر الدرج (دينار/متر):</label>
                    <input type="number" id="stairsRailingPrice" name="stairsRailingPrice" step="any">

                    <label for="stairsRailingLength">طول محجر الدرج (متر):</label>
                    <input type="number" id="stairsRailingLength" name="stairsRailingLength" step="any">
                </div>
            </div>

            <!-- التفاصيل الفنية (الخريطة) -->
            <div class="form-section">
                <h2>التفاصيل الفنية <span class="toggle-icon">▼</span></h2>
                <div class="content" id="mapDetailsInfo">
                    <label for="totalRoofArea">إجمالي مساحة السقوف (متر مربع):</label>
                    <input type="number" id="totalRoofArea" name="totalRoofArea" step="any">

                    <label for="externalAreas">مساحة الحدائق/الممرات (متر مربع):</label>
                    <input type="number" id="externalAreas" name="externalAreas" step="any">

                    <label for="skylightsArea">مساحة المناور (متر مربع):</label>
                    <input type="number" id="skylightsArea" name="skylightsArea" step="any">

                    <label for="tiesLength">طول الرباطات (متر):</label>
                    <input type="number" id="tiesLength" name="tiesLength" step="any">

                    <label for="invertedBeams">الكمرات المقلوبة (متر):</label>
                    <input type="number" id="invertedBeams" name="invertedBeams" step="any">

                    <label for="externalWalls24cm">مساحة الجدران الخارجية 24 سم (متر مربع):</label>
                    <input type="number" id="externalWalls24cm" name="externalWalls24cm" step="any">

                    <label for="internalWalls24cm">مساحة الجدران الداخلية 24 سم (متر مربع):</label>
                    <input type="number" id="internalWalls24cm" name="internalWalls24cm" step="any">

                    <label for="roofFenceLength">طول سياج السطح (متر):</label>
                    <input type="number" id="roofFenceLength" name="roofFenceLength" step="any">

                    <label for="externalDoors">عدد الأبواب الخارجية:</label>
                    <input type="number" id="externalDoors" name="externalDoors">

                    <label for="internalDoors">عدد الأبواب الداخلية:</label>
                    <input type="number" id="internalDoors" name="internalDoors">

                    <label for="facadeWindowsDoorsArea">مساحة شبابيك وأبواب الواجهة (متر مربع):</label>
                    <input type="number" id="facadeWindowsDoorsArea" name="facadeWindowsDoorsArea" step="any">

                    <label for="skylightWindowsDoorsArea">مساحة شبابيك وأبواب المناور (متر مربع):</label>
                    <input type="number" id="skylightWindowsDoorsArea" name="skylightWindowsDoorsArea" step="any">

                    <label for="secondaryCeilingsArea">مساحة الأسقف الثانوية (متر مربع):</label>
                    <input type="number" id="secondaryCeilingsArea" name="secondaryCeilingsArea" step="any">

                    <label for="decorativeWallsArea">مساحة الجدران الزخرفية (متر مربع):</label>
                    <input type="number" id="decorativeWallsArea" name="decorativeWallsArea" step="any">

                    <label for="claddingWallsArea">مساحة الجدران المكسوة (متر مربع):</label>
                    <input type="number" id="claddingWallsArea" name="claddingWallsArea" step="any">
                </div>
            </div>

            <button type="submit">حساب التكلفة</button>
        </form>

        <!-- عرض النتائج -->
        <div id="resultContainer">
            <div id="resultContent"></div>
            <button id="downloadPdf">تحميل PDF</button>
        </div>
    </div>

    <script>
        // تفعيل الأقسام القابلة للطي
        document.querySelectorAll('.form-section h2').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.toggle-icon');
                content.classList.toggle('active');
                icon.classList.toggle('open');
            });
        });

        // إظهار/إخفاء حقول إضافية
        document.getElementById('brickType').addEventListener('change', function() {
            document.getElementById('otherBrickInfo').classList.toggle('hidden', this.value !== 'other');
        });

        document.getElementById('facadeType').addEventListener('change', function() {
            document.getElementById('customFacadeInfo').classList.toggle('hidden', this.value !== 'custom');
        });

        // معالجة إرسال النموذج
        document.getElementById('buildingForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> حساب التكلفة';
            submitBtn.disabled = true;

            try {
                // جمع البيانات من النموذج
                const inputs = {
                    customer: {
                        name: document.getElementById('customerName').value || '',
                        phone: document.getElementById('phoneNumber').value || ''
                    },
                    location: {
                        governorate: document.getElementById('governorate').value || '',
                        area: document.getElementById('area').value || ''
                    },
                    land: {
                        area: parseFloat(document.getElementById('landArea').value) || 0,
                        facadeWidth: parseFloat(document.getElementById('facadeWidth').value) || 0
                    },
                    building: {
                        floors: parseInt(document.getElementById('floors').value) || 0,
                        rooms: parseInt(document.getElementById('rooms').value) || 0,
                        bathrooms: parseInt(document.getElementById('bathrooms').value) || 0,
                        groundFloorHeight: parseFloat(document.getElementById('groundFloorHeight').value) || 0,
                        otherFloorsHeight: parseFloat(document.getElementById('otherFloorsHeight').value) || 0,
                        brickType: document.getElementById('brickType').value || '',
                        woodType: document.getElementById('woodType').value || '',
                        facadeType: document.getElementById('facadeType').value || '',
                        hasGarden: document.getElementById('hasGarden')?.checked || false,
                        hasPool: document.getElementById('hasPool')?.checked || false,
                        hasHVAC: document.getElementById('hasHVAC')?.checked || false,
                        hasElevator: document.getElementById('hasElevator')?.checked || false,
                        hasFence: document.getElementById('hasFence')?.checked || false
                    },
                    prices: {
                        flooring: parseFloat(document.getElementById('flooringPrice').value) || 0,
                        wallInstallation: parseFloat(document.getElementById('wallInstallationPrice').value) || 0,
                        wallPainting: parseFloat(document.getElementById('wallPaintingPrice').value) || 0,
                        windowsDoors: parseFloat(document.getElementById('windowsDoorsPrice').value) || 0,
                        stairsRailing: parseFloat(document.getElementById('stairsRailingPrice').value) || 0
                    },
                    stairsRailingLength: parseFloat(document.getElementById('stairsRailingLength').value) || 0,
                    hasMap: !document.getElementById('mapDetailsInfo').classList.contains('hidden')
                };

                if (!document.getElementById('otherBrickInfo').classList.contains('hidden')) {
                    inputs.building.brickDetails = {
                        width: parseFloat(document.getElementById('brickWidth').value) || 0,
                        length: parseFloat(document.getElementById('brickLength').value) || 0,
                        height: parseFloat(document.getElementById('brickHeight').value) || 0,
                        density: parseFloat(document.getElementById('brickDensity').value) || 0
                    };
                }
                if (document.getElementById('concreteVolume').value) {
                    inputs.building.concreteVolume = parseFloat(document.getElementById('concreteVolume').value) || 0;
                }
                if (document.getElementById('apartmentsCount').value) {
                    inputs.building.apartmentsCount = parseInt(document.getElementById('apartmentsCount').value) || 0;
                }
                if (!document.getElementById('customFacadeInfo').classList.contains('hidden')) {
                    inputs.building.customFacade = {
                        area: parseFloat(document.getElementById('facadeArea').value) || 0,
                        price: parseFloat(document.getElementById('facadePrice').value) || 0
                    };
                }
                if (document.getElementById('internalWallsArea').value) {
                    inputs.building.internalWalls = {
                        area: parseFloat(document.getElementById('internalWallsArea').value) || 0,
                        price: parseFloat(document.getElementById('internalWallsPrice').value) || 0
                    };
                }
                if (document.getElementById('basementFloors').value) {
                    inputs.building.basement = {
                        floors: parseInt(document.getElementById('basementFloors').value) || 0,
                        ceilingArea: parseFloat(document.getElementById('basementCeilingArea').value) || 0,
                        price: parseFloat(document.getElementById('basementPrice').value) || 0
                    };
                }
                if (inputs.hasMap) {
                    inputs.technicalDetails = {
                        totalRoofArea: parseFloat(document.getElementById('totalRoofArea').value) || 0,
                        externalAreas: parseFloat(document.getElementById('externalAreas').value) || 0,
                        skylightsArea: parseFloat(document.getElementById('skylightsArea').value) || 0,
                        tiesLength: parseFloat(document.getElementById('tiesLength').value) || 0,
                        invertedBeams: parseFloat(document.getElementById('invertedBeams').value) || 0,
                        externalWalls24cm: parseFloat(document.getElementById('externalWalls24cm').value) || 0,
                        internalWalls24cm: parseFloat(document.getElementById('internalWalls24cm').value) || 0,
                        roofFenceLength: parseFloat(document.getElementById('roofFenceLength').value) || 0,
                        externalDoors: parseInt(document.getElementById('externalDoors').value) || 0,
                        internalDoors: parseInt(document.getElementById('internalDoors').value) || 0,
                        facadeWindowsDoorsArea: parseFloat(document.getElementById('facadeWindowsDoorsArea').value) || 0,
                        skylightWindowsDoorsArea: parseFloat(document.getElementById('skylightWindowsDoorsArea').value) || 0,
                        secondaryCeilingsArea: parseFloat(document.getElementById('secondaryCeilingsArea').value) || 0,
                        decorativeWallsArea: parseFloat(document.getElementById('decorativeWallsArea').value) || 0,
                        claddingWallsArea: parseFloat(document.getElementById('claddingWallsArea').value) || 0
                    };
                }

                // تسجيل البيانات المرسلة
                console.log('البيانات المرسلة:', JSON.stringify(inputs, (key, value) => {
                    if (value === undefined) return 'undefined';
                    if (value === null) return 'null';
                    return value;
                }, 2));

                // إرسال البيانات إلى نقطة نهاية API
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`خطأ في الاتصال بالخادم: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('استجابة الخادم:', result);

                // عرض النتائج
                const resultContainer = document.getElementById('resultContainer');
                const resultContent = document.getElementById('resultContent');

                resultContent.innerHTML = `
                    <div class="result-section" id="pdfContent">
                        <h3>نتيجة الحساب</h3>
                        <p><strong>التكلفة الإجمالية:</strong> ${result.totalCost.toLocaleString()} دينار عراقي</p>
                        <h4>تفاصيل التكاليف:</h4>
                        <ul>
                            <li>تكلفة الأرضيات: ${result.breakdown.flooringCost.toLocaleString()} دينار</li>
                            <li>تكلفة تركيب الجدران: ${result.breakdown.wallInstallationCost.toLocaleString()} دينار</li>
                            <li>تكلفة صبغ الجدران: ${result.breakdown.wallPaintingCost.toLocaleString()} دينار</li>
                            <li>تكلفة الشبابيك والأبواب: ${result.breakdown.windowsDoorsCost.toLocaleString()} دينار</li>
                            <li>تكلفة محجر الدرج: ${result.breakdown.stairsRailingCost.toLocaleString()} دينار</li>
                            ${result.breakdown.roofCost ? `<li>تكلفة السقوف: ${result.breakdown.roofCost.toLocaleString()} دينار</li>` : ''}
                            ${result.breakdown.externalAreasCost ? `<li>تكلفة المناطق الخارجية: ${result.breakdown.externalAreasCost.toLocaleString()} دينار</li>` : ''}
                            ${result.breakdown.skylightsCost ? `<li>تكلفة المناور: ${result.breakdown.skylightsCost.toLocaleString()} دينار</li>` : ''}
                            ${result.breakdown.tiesCost ? `<li>تكلفة الرباطات: ${result.breakdown.tiesCost.toLocaleString()} دينار</li>` : ''}
                            ${result.breakdown.externalWallsCost ? `<li>تكلفة الجدران الخارجية: ${result.breakdown.externalWallsCost.toLocaleString()} دينار</li>` : ''}
                            ${result.breakdown.internalWallsCost ? `<li>تكلفة الجدران الداخلية: ${result.breakdown.internalWallsCost.toLocaleString()} دينار</li>` : ''}
                            ${result.breakdown.roofFenceCost ? `<li>تكلفة سياج السطح: ${result.breakdown.roofFenceCost.toLocaleString()} دينار</li>` : ''}
                        </ul>
                        <p><strong>ملاحظات:</strong> ${result.details}</p>
                    </div>
                `;

                resultContainer.style.display = 'block';

                // تفعيل زر تحميل PDF
                document.getElementById('downloadPdf').addEventListener('click', function() {
                    const pdfContent = document.getElementById('pdfContent').innerHTML;
                    const pdfWindow = window.open('');
                    pdfWindow.document.write(`
                        <html dir="rtl">
                        <head>
                            <title>تقرير تكاليف البناء</title>
                            <style>
                                body { font-family: 'Tajawal', sans-serif; padding: 20px; }
                                h3 { color: #0a3d62; }
                                p, ul { line-height: 1.6; }
                                ul { padding-right: 20px; }
                            </style>
                        </head>
                        <body>${pdfContent}</body>
                        </html>
                    `);
                    pdfWindow.document.close();
                    pdfWindow.print();
                });

            } catch (error) {
                console.error('خطأ:', error);
                document.getElementById('resultContent').innerHTML = `<p style="color: red;">خطأ: ${error.message}</p>`;
                document.getElementById('resultContainer').style.display = 'block';
            } finally {
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
